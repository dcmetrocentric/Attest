<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ATTEST — Demo</title>
<style>
:root{
  --bg1:#0b1220; --bg2:#0e1730;
  --card:#121b31; --card2:#0f172a;
  --text:#eaf0ff; --muted:#a7b6da;
  --indigo:#4f46e5; --cyan:#06b6d4; --green:#22c55e; --amber:#f59e0b; --red:#ef4444;
  --shadow: 0 18px 60px rgba(0,0,0,.35);
  --radius: 22px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color:var(--text);
  background: radial-gradient(1200px 700px at 20% -10%, #24356f 0%, rgba(36,53,111,0) 60%),
              radial-gradient(900px 600px at 110% 10%, #0ea5e9 0%, rgba(14,165,233,0) 52%),
              linear-gradient(180deg, var(--bg1), var(--bg2));
  min-height:100vh;
  padding: 18px 14px 36px;
}
.phone{
  max-width: 430px;
  margin: 0 auto;
  border-radius: 34px;
  padding: 16px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  box-shadow: var(--shadow);
}
.header{
  display:flex; align-items:center; justify-content:space-between;
  padding: 6px 6px 10px;
}
.brand{display:flex; align-items:center; gap:10px}
.logo{
  width: 38px; height: 38px; border-radius: 14px;
  background: linear-gradient(135deg, var(--cyan), var(--indigo));
  position:relative;
}
.logo:after{
  content:""; position:absolute; inset:10px;
  border-radius: 10px;
  border: 2px solid rgba(255,255,255,.85);
  transform: rotate(12deg);
}
.brand .name{font-weight: 900; letter-spacing:.08em}
.tagline{font-size:12px; color:var(--muted); margin-top:2px; max-width: 250px; line-height: 1.2}
.pill{
  font-size: 12px;
  color: rgba(255,255,255,.85);
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
}
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border: 1px solid rgba(255,255,255,.10);
  border-radius: var(--radius);
  padding: 14px;
  margin: 10px 0;
}
.row{display:flex; gap:10px}
.row > *{flex:1}
.label{font-size:12px; color:var(--muted); margin-bottom:6px}
.value{font-weight:800}
hr.sep{
  border:0; height:1px;
  background: rgba(255,255,255,.10);
  margin: 12px 0;
}
.btn{
  width:100%;
  border:0;
  border-radius: 18px;
  padding: 14px 14px;
  font-weight: 900;
  color:white;
  background: linear-gradient(135deg, var(--indigo), var(--cyan));
  box-shadow: 0 10px 24px rgba(79,70,229,.22);
  cursor:pointer;
}
.btn:active{transform: translateY(1px)}
.btn.secondary{
  background: rgba(255,255,255,.10);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow:none;
}
.btn.danger{
  background: rgba(239,68,68,.16);
  border: 1px solid rgba(239,68,68,.28);
}
.smallbtn{padding: 10px 12px; border-radius: 14px; font-weight: 900}
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.chip{
  display:inline-flex; align-items:center; gap:8px;
  font-size:12px; color: rgba(255,255,255,.9);
  padding: 7px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
}
.dot{width:8px; height:8px; border-radius:999px; background:var(--green)}
.dot.amber{background:var(--amber)}
.dot.red{background:var(--red)}
.list{display:flex; flex-direction:column; gap:10px}
.item{
  display:flex; gap:10px; align-items:center;
  padding: 10px;
  border-radius: 18px;
  background: rgba(15,23,42,.55);
  border: 1px solid rgba(255,255,255,.10);
}
.thumb{
  width: 44px; height: 44px; border-radius: 14px;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.12);
  display:flex; align-items:center; justify-content:center;
  font-weight: 900;
}
.item .meta{flex:1}
.item .meta .top{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
.item .meta .name{font-weight:900}
.item .meta .sub{font-size:12px; color: var(--muted); margin-top:2px}
.item .actions{display:flex; flex-direction:column; gap:8px}
.input{
  width:100%;
  padding: 12px 12px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--text);
  outline: none;
}
.input[readonly]{opacity:.92}
.screen{display:none}
.screen.active{display:block}
.footerNote{font-size:12px;color:var(--muted);text-align:center;margin-top:10px}
.badge{
  display:inline-block;
  padding: 6px 10px;
  border-radius: 999px;
  font-size:12px;
  font-weight:900;
  background: rgba(34,197,94,.14);
  border: 1px solid rgba(34,197,94,.28);
}
.badge.warn{background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.28)}
.badge.block{background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.28)}

.stepPill{
  display:inline-flex; align-items:center; gap:8px;
  padding: 6px 10px; border-radius: 999px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  font-size: 12px; color: rgba(255,255,255,.92);
  font-weight: 900;
}
.stepNum{
  width:18px; height:18px; border-radius:999px;
  background: rgba(6,182,212,.25);
  border: 1px solid rgba(6,182,212,.35);
  display:flex; align-items:center; justify-content:center;
  font-size: 11px;
}
</style>
</head>
<body>
  <div class="phone" role="application" aria-label="ATTEST demo">
    <div class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="name">ATTEST</div>
          <div class="tagline">A real-time authorization and intent network for payments</div>
        </div>
      </div>
      <div class="pill" id="pillStatus">Ready</div>
    </div>

    <!-- HOME -->
    <section class="screen active" id="home">
      <div class="card">
        <div class="row">
          <div>
            <div class="label">Account</div>
            <div class="value" id="userName">Jamie</div>
            <div class="label" style="margin-top:6px">Spend rules</div>
            <div class="value" id="policyName">Everyday — Balanced</div>
          </div>
          <div>
            <div class="label">Card</div>
            <div class="value">•••• <span id="cardLast4">1842</span></div>
            <div class="label" style="margin-top:6px">Today</div>
            <div class="value">$<span id="todaySpend">82.40</span> / $<span id="dailyLimit">250</span></div>
          </div>
        </div>
        <hr class="sep"/>
        <div class="grid2">
          <button class="btn" id="btnStart">New purchase</button>
          <button class="btn secondary" id="btnPolicy">Spend rules</button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between">
          <div>
            <div class="label">Recent</div>
            <div style="font-size:12px;color:var(--muted)">Each transaction includes its approval status</div>
          </div>
          <div class="chip"><span class="dot"></span> Live</div>
        </div>
        <div class="list" id="recentList" style="margin-top:10px"></div>
      </div>

      <div class="footerNote">Demo tip: take a photo first — we auto-fill the details.</div>
    </section>

    <!-- POLICY -->
    <section class="screen" id="policy">
      <div class="card">
        <div class="row" style="align-items:flex-start">
          <div>
            <div class="label">Spend rules</div>
            <div class="value" id="policyTitle">Everyday — Balanced</div>
            <div class="label" style="margin-top:10px">Auto-approved</div>
            <div id="autoCats" style="display:flex; flex-wrap:wrap; gap:8px"></div>
          </div>
        </div>
        <hr class="sep"/>
        <div class="label">May require approval</div>
        <div id="needsCats" style="display:flex; flex-wrap:wrap; gap:8px"></div>
        <hr class="sep"/>
        <div class="label">Not allowed</div>
        <div id="blockedCats" style="display:flex; flex-wrap:wrap; gap:8px"></div>
      </div>
      <button class="btn secondary" id="btnBackFromPolicy">Back</button>
    </section>

    <!-- CAPTURE ITEM -->
    <section class="screen" id="capture">
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
          <div>
            <div class="label">Step 1 — Capture</div>
            <div class="value">Take a photo of the item</div>
          </div>
          <div class="stepPill" id="itemPill"><span class="stepNum" id="itemNum">1</span> Item <span id="itemCountText">1</span></div>
        </div>

        <div style="height:10px"></div>
        <label class="label">Photo</label>
        <input class="input" id="fileInput" type="file" accept="image/*" capture="environment"/>
        <div id="previewWrap" style="margin-top:10px; display:none">
          <img id="previewImg" alt="Evidence preview" style="width:100%; border-radius:16px; border:1px solid rgba(255,255,255,.14)"/>
        </div>

        <hr class="sep"/>
        <label class="label" for="merchantInput">Merchant (auto-filled)</label>
        <input class="input" id="merchantInput" readonly />

        <div style="height:10px"></div>
        <label class="label" for="catInput">Category (auto-filled)</label>
        <input class="input" id="catInput" readonly />

        <div style="height:10px"></div>
        <label class="label" for="amountInput">Approximate amount (you enter)</label>
        <input class="input" id="amountInput" inputmode="decimal" placeholder="e.g., 39.99" />

        <hr class="sep"/>
        <div class="grid2">
          <button class="btn secondary" id="btnAddItem">Add item</button>
          <button class="btn" id="btnFinishPay">Finish and Pay</button>
        </div>
      </div>
      <button class="btn secondary" id="btnCancelPurchase">Cancel</button>
      <div class="footerNote">We auto-detect merchant + category in the demo when you attach a photo.</div>
    </section>

    <!-- CART -->
    <section class="screen" id="cart">
      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between">
          <div>
            <div class="label">Step 2 — Review</div>
            <div class="value">Your items</div>
          </div>
          <div class="badge" id="approvalBadge">Auto-approved</div>
        </div>
        <hr class="sep"/>
        <div class="list" id="cartList"></div>
        <hr class="sep"/>
        <div class="row">
          <div>
            <div class="label">Merchant</div>
            <div class="value" id="cartMerchant">—</div>
          </div>
          <div>
            <div class="label">Total</div>
            <div class="value">$<span id="cartTotal">0.00</span></div>
          </div>
        </div>
      </div>

      <div class="grid2">
        <button class="btn secondary" id="btnAddMore">Add another item</button>
        <button class="btn" id="btnProceed">Proceed to pay</button>
      </div>
      <div style="height:10px"></div>
      <button class="btn secondary" id="btnBackHome">Back to home</button>
    </section>

    <!-- PAY -->
    <section class="screen" id="pay">
      <div class="card">
        <div class="label">Step 3 — Tap to pay</div>
        <div class="value">Ready when approved</div>
        <hr class="sep"/>
        <div class="row">
          <div>
            <div class="label">Merchant</div>
            <div class="value" id="payMerchant">—</div>
          </div>
          <div>
            <div class="label">Total</div>
            <div class="value">$<span id="payTotal">0.00</span></div>
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="card" style="margin:0; background: rgba(255,255,255,.05)">
          <div class="row" style="align-items:center; justify-content:space-between">
            <div class="chip"><span class="dot" id="permitDot"></span> <span id="permitText">Permit active (10 min)</span></div>
            <div class="pill" id="timerPill">10:00</div>
          </div>
          <div style="margin-top:10px; font-size:12px; color: var(--muted)">
            Demo: we simulate the real-time authorization decision during the tap.
          </div>
        </div>
        <div style="height:12px"></div>
        <button class="btn" id="btnSimTap">Simulate tap</button>
        <div style="height:10px"></div>
        <button class="btn secondary" id="btnFinish">Finish</button>
      </div>
    </section>

    <!-- RESULT -->
    <section class="screen" id="result">
      <div class="card">
        <div class="label">Result</div>
        <div class="value" id="resultTitle">Approved</div>
        <div style="margin-top:8px; color: var(--muted)" id="resultDetail">—</div>
        <hr class="sep"/>
        <div class="row">
          <div>
            <div class="label">Authorization</div>
            <div class="value" id="authId">AUTH-—</div>
          </div>
          <div>
            <div class="label">Status</div>
            <div class="value" id="statusText">—</div>
          </div>
        </div>
      </div>
      <div class="grid2">
        <button class="btn" id="btnNewPurchase">New purchase</button>
        <button class="btn secondary" id="btnBackToHome2">Back to home</button>
      </div>
    </section>
  </div>

<script>
(function(){
  var state = {
    cart: [],
    permitExpiresAt: 0,
    permitActive: false,
    user: { name:"Jamie", last4:"1842" },
    policy: {
      name:"Everyday — Balanced",
      autoApproved:["Groceries","Gas","Parking/Tolls","Household"],
      requiresApproval:["Electronics","Large purchases"],
      blocked:["Gift cards","Alcohol","Cash equivalents"],
      dailyLimit:250,
      todaySpend:82.40
    },
    recent: [
      { merchant:"Shell", amount:18.22, status:"Approved", badge:"ok" },
      { merchant:"Target", amount:46.13, status:"Approved", badge:"ok" },
      { merchant:"Best Buy", amount:229.99, status:"Needs approval", badge:"warn" }
    ],
    autoFill: {
      merchants:["Target","Walmart","CVS","Home Depot","Whole Foods","Costco","Shell","Starbucks","Trader Joe’s"],
      categories:["Groceries","Household","Pharmacy","Hardware","Gas","Food & Drink","Electronics","Office supplies","Safety supplies"]
    }
  };

  function $(id){ return document.getElementById(id); }
  function setPill(text){ $("pillStatus").textContent = text; }
  function show(screenId){
    document.querySelectorAll(".screen").forEach(function(s){ s.classList.remove("active"); });
    var el = $(screenId); if(el) el.classList.add("active");
    window.scrollTo(0,0);
  }
  function fmtMoney(n){ return (Math.round(n*100)/100).toFixed(2); }
  function makeChip(text, kind){
    var span = document.createElement("span");
    span.className = "chip";
    var dot = document.createElement("span");
    dot.className = "dot" + (kind ? (" " + kind) : "");
    span.appendChild(dot);
    span.appendChild(document.createTextNode(" " + text));
    return span;
  }
  function renderPolicy(){
    $("policyTitle").textContent = state.policy.name;
    $("autoCats").innerHTML = "";
    state.policy.autoApproved.forEach(function(t){ $("autoCats").appendChild(makeChip(t)); });
    $("needsCats").innerHTML = "";
    state.policy.requiresApproval.forEach(function(t){ $("needsCats").appendChild(makeChip(t, "amber")); });
    $("blockedCats").innerHTML = "";
    state.policy.blocked.forEach(function(t){ $("blockedCats").appendChild(makeChip(t, "red")); });
  }
  function renderRecent(){
    var host = $("recentList"); host.innerHTML = "";
    state.recent.slice(0,4).forEach(function(tx){
      var row = document.createElement("div"); row.className = "item";
      var th = document.createElement("div"); th.className = "thumb"; th.textContent = tx.merchant.substring(0,1).toUpperCase();
      var meta = document.createElement("div"); meta.className = "meta";
      var top = document.createElement("div"); top.className = "top";
      var name = document.createElement("div"); name.className = "name"; name.textContent = tx.merchant;
      var amt = document.createElement("div"); amt.className = "name"; amt.textContent = "$" + fmtMoney(tx.amount);
      top.appendChild(name); top.appendChild(amt);
      var sub = document.createElement("div"); sub.className = "sub"; sub.textContent = tx.status;
      meta.appendChild(top); meta.appendChild(sub);
      var chip = document.createElement("div"); chip.className = "chip";
      var dot = document.createElement("span"); dot.className = "dot" + (tx.badge==="warn" ? " amber" : (tx.badge==="red" ? " red" : ""));
      chip.appendChild(dot); chip.appendChild(document.createTextNode(" " + tx.status));
      row.appendChild(th); row.appendChild(meta); row.appendChild(chip);
      host.appendChild(row);
    });
  }
  function normalizeMerchant(s){ return (s||"").trim() || "Unknown Merchant"; }
  function normalizeCategory(s){ return (s||"").trim() || "Uncategorized"; }
  function parseAmount(s){
    var n = parseFloat((s||"").replace(/[^0-9.]/g,""));
    return isFinite(n) ? n : 0;
  }
  function itemStatus(item){
    var cat = (item.category||"").toLowerCase();
    var blocked = ["gift","alcohol","cash"];
    for(var i=0;i<blocked.length;i++){ if(cat.indexOf(blocked[i]) >= 0) return "Blocked"; }
    if(item.amount > 200) return "Needs approval";
    var auto = state.policy.autoApproved.map(function(x){ return x.toLowerCase(); });
    if(auto.indexOf(cat.toLowerCase()) >= 0) return "Approved";
    return "Needs approval";
  }
  function overallApproval(){
    if(state.cart.length === 0) return { status:"—", badge:"warn" };
    if(state.cart.some(function(i){ return itemStatus(i) === "Blocked"; })) return { status:"Blocked", badge:"block" };
    if(state.cart.some(function(i){ return itemStatus(i) === "Needs approval"; })) return { status:"Needs approval", badge:"warn" };
    return { status:"Auto-approved", badge:"ok" };
  }
  function renderCart(){
    var list = $("cartList"); list.innerHTML = "";
    if(state.cart.length === 0){
      var empty = document.createElement("div");
      empty.style.color = "var(--muted)";
      empty.textContent = "No items yet. Add an item first.";
      list.appendChild(empty);
    } else {
      state.cart.forEach(function(item, idx){
        var row = document.createElement("div"); row.className = "item";
        var th = document.createElement("div"); th.className = "thumb"; th.textContent = String(idx+1);
        var meta = document.createElement("div"); meta.className = "meta";
        var top = document.createElement("div"); top.className = "top";
        var name = document.createElement("div"); name.className = "name"; name.textContent = item.name || ("Item " + (idx+1));
        var amt = document.createElement("div"); amt.className = "name"; amt.textContent = "$" + fmtMoney(item.amount);
        top.appendChild(name); top.appendChild(amt);
        var sub = document.createElement("div"); sub.className = "sub";
        sub.textContent = item.merchant + " • " + item.category + " • " + itemStatus(item);
        meta.appendChild(top); meta.appendChild(sub);

        var actions = document.createElement("div"); actions.className = "actions";
        var rm = document.createElement("button");
        rm.className = "btn danger smallbtn"; rm.textContent = "Remove";
        rm.addEventListener("click", function(){ state.cart.splice(idx,1); renderCart(); updateItemPill(); });
        actions.appendChild(rm);

        row.appendChild(th); row.appendChild(meta); row.appendChild(actions);
        list.appendChild(row);
      });
    }
    var total = state.cart.reduce(function(s,i){ return s + (i.amount||0); }, 0);
    $("cartTotal").textContent = fmtMoney(total);
    $("cartMerchant").textContent = state.cart[0] ? normalizeMerchant(state.cart[0].merchant) : "—";

    var appr = overallApproval();
    var badge = $("approvalBadge");
    badge.textContent = appr.status;
    badge.className = "badge" + (appr.badge==="warn" ? " warn" : (appr.badge==="block" ? " block" : ""));
  }

  function clearCaptureForm(){
    $("amountInput").value = "";
    $("fileInput").value = "";
    $("previewWrap").style.display = "none";
    $("previewImg").src = "";
    // Keep auto-filled values until next photo, so the user sees them
  }

  function autoFillFromPhoto(){
    var m = state.autoFill.merchants[Math.floor(Math.random()*state.autoFill.merchants.length)];
    var c = state.autoFill.categories[Math.floor(Math.random()*state.autoFill.categories.length)];
    $("merchantInput").value = m;
    $("catInput").value = c;
    setPill("Details auto-filled");
    setTimeout(function(){ setPill("Capturing"); }, 900);
  }

  var timerInt = null;
  function startPermit(minutes){
    state.permitActive = true;
    state.permitExpiresAt = Date.now() + minutes*60*1000;
    $("permitDot").className = "dot";
    if(timerInt) clearInterval(timerInt);
    timerInt = setInterval(function(){
      var ms = state.permitExpiresAt - Date.now();
      if(ms <= 0){
        state.permitActive = false;
        clearInterval(timerInt);
        $("timerPill").textContent = "Expired";
        $("permitText").textContent = "Permit expired";
        $("permitDot").className = "dot red";
        setPill("Permit expired");
      } else {
        var s = Math.floor(ms/1000);
        var m = Math.floor(s/60);
        var r = s % 60;
        $("timerPill").textContent = String(m).padStart(2,"0") + ":" + String(r).padStart(2,"0");
      }
    }, 250);
  }

  function proceedToPay(){
    var total = state.cart.reduce(function(s,i){ return s + (i.amount||0); }, 0);
    $("payTotal").textContent = fmtMoney(total);
    $("payMerchant").textContent = state.cart[0] ? normalizeMerchant(state.cart[0].merchant) : "—";
    $("permitText").textContent = "Permit active (10 min)";
    $("timerPill").textContent = "10:00";
    setPill("Permit active");
    startPermit(10);
    show("pay");
  }

  function simulateTap(){
    var appr = overallApproval();
    var total = state.cart.reduce(function(s,i){ return s + (i.amount||0); }, 0);
    var auth = "AUTH-" + Math.random().toString(16).slice(2,8).toUpperCase();

    if(!state.permitActive){
      $("resultTitle").textContent = "Declined";
      $("resultDetail").textContent = "Permit expired — authorization denied.";
      $("statusText").textContent = "Declined";
    } else if(appr.status === "Blocked"){
      $("resultTitle").textContent = "Declined";
      $("resultDetail").textContent = "Not allowed by your spend rules.";
      $("statusText").textContent = "Declined";
    } else if(appr.status === "Needs approval"){
      $("resultTitle").textContent = "Pending";
      $("resultDetail").textContent = "Approval needed. In production this routes instantly.";
      $("statusText").textContent = "Pending";
    } else {
      $("resultTitle").textContent = "Approved";
      $("resultDetail").textContent = "Approved in real time. Receipt evidence attached.";
      $("statusText").textContent = "Approved";
      state.policy.todaySpend = state.policy.todaySpend + total;
      $("todaySpend").textContent = fmtMoney(state.policy.todaySpend);
      state.recent.unshift({ merchant: normalizeMerchant(state.cart[0].merchant), amount: total, status:"Approved", badge:"ok" });
      renderRecent();
    }
    $("authId").textContent = auth;
    state.permitActive = false;
    if(timerInt) clearInterval(timerInt);
    setPill("Complete");
    show("result");
  }

  function updateItemPill(){
    var next = state.cart.length + 1;
    $("itemNum").textContent = String(next);
    $("itemCountText").textContent = String(next);
  }

  function startPurchase(){
    state.cart = [];
    $("merchantInput").value = "";
    $("catInput").value = "";
    clearCaptureForm();
    updateItemPill();
    setPill("Capturing");
    show("capture");
  }

  function addCurrentItemToCart(){
    var merchant = normalizeMerchant($("merchantInput").value);
    var category = normalizeCategory($("catInput").value);
    var amount = parseAmount($("amountInput").value);
    if(amount <= 0){
      alert("Enter an approximate amount to add this item.");
      return false;
    }
    // enforce one-merchant-per-checkout for realism
    if(state.cart.length > 0){
      var existing = normalizeMerchant(state.cart[0].merchant);
      if(existing.toLowerCase() !== merchant.toLowerCase()){
        alert("This demo keeps one checkout to one merchant. Start a new purchase for a different merchant.");
        return false;
      }
    }
    var idx = state.cart.length + 1;
    state.cart.push({
      merchant: merchant,
      category: category,
      amount: amount,
      name: "Item " + idx
    });
    clearCaptureForm();
    updateItemPill();
    setPill("Item " + idx + " added");
    setTimeout(function(){ setPill("Capturing"); }, 900);
    return true;
  }

  function init(){
    $("userName").textContent = state.user.name;
    $("policyName").textContent = state.policy.name;
    $("cardLast4").textContent = state.user.last4;
    $("todaySpend").textContent = fmtMoney(state.policy.todaySpend);
    $("dailyLimit").textContent = fmtMoney(state.policy.dailyLimit);

    renderRecent();
    renderPolicy();

    $("btnStart").addEventListener("click", startPurchase);
    $("btnPolicy").addEventListener("click", function(){ show("policy"); setPill("Spend rules"); });
    $("btnBackFromPolicy").addEventListener("click", function(){ show("home"); setPill("Ready"); });

    $("btnCancelPurchase").addEventListener("click", function(){ show("home"); setPill("Ready"); });

    $("btnAddItem").addEventListener("click", function(){
      if(!$("merchantInput").value){
        alert("Take a photo first so we can auto-fill the details.");
        return;
      }
      addCurrentItemToCart();
    });

    $("btnFinishPay").addEventListener("click", function(){
      // If there is an amount entered, treat it as adding the current item before finishing.
      if($("merchantInput").value && $("amountInput").value.trim()){
        var ok = addCurrentItemToCart();
        if(!ok) return;
      }
      if(state.cart.length === 0){
        alert("Add at least one item first.");
        return;
      }
      renderCart();
      show("cart");
      setPill("Reviewing");
    });

    $("btnAddMore").addEventListener("click", function(){ show("capture"); setPill("Capturing"); });

    $("btnProceed").addEventListener("click", function(){
      if(state.cart.length === 0){ alert("Add at least one item first."); return; }
      proceedToPay();
    });

    $("btnBackHome").addEventListener("click", function(){ show("home"); setPill("Ready"); });

    $("btnSimTap").addEventListener("click", simulateTap);
    $("btnFinish").addEventListener("click", function(){ show("home"); setPill("Ready"); });

    $("btnNewPurchase").addEventListener("click", startPurchase);
    $("btnBackToHome2").addEventListener("click", function(){ show("home"); setPill("Ready"); });

    $("fileInput").addEventListener("change", function(){
      var f = this.files && this.files[0] ? this.files[0] : null;
      if(!f){ $("previewWrap").style.display = "none"; return; }
      var url = URL.createObjectURL(f);
      $("previewImg").src = url;
      $("previewWrap").style.display = "block";
      // demo auto-fill
      autoFillFromPhoto();
    });

    show("home");
    setPill("Ready");
  }

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
</body>
</html>
