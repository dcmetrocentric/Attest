<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ATTEST â€” Demo</title>
<style>

:root{
  --bg1:#0b1220; --bg2:#0e1730;
  --card:#121b31; --card2:#0f172a;
  --text:#eaf0ff; --muted:#a7b6da;
  --indigo:#4f46e5; --cyan:#06b6d4; --green:#22c55e; --amber:#f59e0b; --red:#ef4444;
  --shadow: 0 22px 46px rgba(0,0,0,.38);
  --radius:22px;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text)}
a{color:inherit}
#app{min-height:100vh;display:flex;flex-direction:column}
header{
  position:sticky;top:0;z-index:10;
  padding:14px 16px 10px;
  backdrop-filter: blur(10px);
  background: rgba(11,18,32,.72);
  border-bottom: 1px solid rgba(255,255,255,.06);
}
.brand{display:flex;align-items:center;gap:10px}
.mark{width:30px;height:30px;border-radius:10px;background:linear-gradient(135deg,var(--indigo),#7c8cff);display:grid;place-items:center;box-shadow:0 10px 24px rgba(79,70,229,.35)}
.mark:before{content:"âœ“";font-weight:900}
.brand span{font-weight:800;letter-spacing:.6px}
.container{padding:16px 16px 24px;max-width:520px;margin:0 auto;width:100%}
.card{background:rgba(18,27,49,.92);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
.row{display:flex;gap:12px;align-items:center;justify-content:space-between}
.h1{font-size:24px;font-weight:900;letter-spacing:-.2px}
.h2{font-size:18px;font-weight:800}
.small{font-size:12px;color:var(--muted)}
.muted{color:var(--muted)}
.pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);padding:8px 10px;border-radius:999px;font-weight:700;font-size:13px}
.pill .dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
.pill.warn .dot{background:var(--amber)}
.pill.bad .dot{background:var(--red)}
hr{border:none;border-top:1px solid rgba(255,255,255,.08);margin:14px 0}
.btn{
  width:100%;border:none;border-radius:16px;padding:14px 14px;font-size:16px;font-weight:900;
  color:white;background:var(--indigo);box-shadow:0 12px 26px rgba(79,70,229,.25);
}
.btn.secondary{background:#223057;box-shadow:none}
.btn.green{background:var(--green);box-shadow:0 12px 26px rgba(34,197,94,.22)}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.12);box-shadow:none}
.btn:active{transform:translateY(1px)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.list{display:flex;flex-direction:column;gap:10px}
.tx{
  display:flex;gap:12px;align-items:flex-start;justify-content:space-between;
  padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.06);
  background: rgba(255,255,255,.03);
}
.tx .left{display:flex;flex-direction:column;gap:4px}
.badge{
  font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:8px;
  border:1px solid rgba(255,255,255,.10)
}
.badge .dot{width:8px;height:8px;border-radius:50%}
.badge.approved{background:rgba(34,197,94,.12)} .badge.approved .dot{background:var(--green)}
.badge.pending{background:rgba(245,158,11,.12)} .badge.pending .dot{background:var(--amber)}
.badge.declined{background:rgba(239,68,68,.12)} .badge.declined .dot{background:var(--red)}
.kv{display:flex;flex-direction:column;gap:3px}
.kv b{font-size:14px}
.kv span{font-size:12px;color:var(--muted)}
/* screens */
.screen{display:none}
.screen.active{display:block}
/* Camera */
.camWrap{position:relative;border-radius:24px;overflow:hidden;border:1px solid rgba(255,255,255,.08);background:#000;box-shadow:var(--shadow)}
video{width:100%;height:56vh;max-height:520px;object-fit:cover;display:block}
.scanOverlay{
  position:absolute;inset:0;pointer-events:none;
  background: radial-gradient(circle at 50% 40%, rgba(255,255,255,.06), rgba(0,0,0,.45) 70%);
}
.scanBox{
  position:absolute;left:12%;right:12%;top:22%;height:46%;
  border-radius:22px;border:2px solid rgba(255,255,255,.28)
}
.scanLine{
  position:absolute;left:14%;right:14%;top:26%;
  height:2px;background:linear-gradient(90deg,transparent,var(--cyan),transparent);
  filter: drop-shadow(0 0 10px rgba(6,182,212,.65));
  animation: sweep 1.8s ease-in-out infinite;
}
@keyframes sweep{0%{transform:translateY(0)}50%{transform:translateY(220px)}100%{transform:translateY(0)}}
.sheet{
  margin-top:-18px; position:relative;
}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chip{
  padding:10px 12px;border-radius:999px;font-weight:800;font-size:13px;
  border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04)
}
.chip strong{color:var(--cyan)}
.preview{
  width:100%;border-radius:18px;border:1px solid rgba(255,255,255,.10);overflow:hidden;background:#000;
}
.preview img{width:100%;display:block}
.timer{font-size:44px;font-weight:1000;letter-spacing:-1px}
.walletDim{
  position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:50;
}
.walletCard{
  width:300px;height:180px;border-radius:26px;background:linear-gradient(135deg,var(--indigo),#7c8cff);
  box-shadow:0 18px 48px rgba(0,0,0,.6);
  display:flex;align-items:flex-end;padding:18px;font-weight:900
}
.success{font-size:28px;font-weight:1000;margin-top:14px}


/* --- Compatibility styles for multi-item screens (v5) --- */
.stepPill{
  display:inline-flex; align-items:center; gap:8px;
  padding: 6px 10px; border-radius: 999px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  font-size: 12px; color: rgba(255,255,255,.92);
  font-weight: 900;
}
.stepNum{
  width:18px; height:18px; border-radius:999px;
  background: rgba(6,182,212,.18);
  border: 1px solid rgba(6,182,212,.28);
  display:flex; align-items:center; justify-content:center;
  font-size: 11px;
}
/* Reuse index button styles but allow our "danger" */
.btn.danger{background: rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.28); box-shadow:none}
/* Inputs in detail screens */
.input{
  width:100%;
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  outline:none;
}
.input[readonly]{opacity:.92}
/* Item rows */
.item{
  display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
  padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.06);
  background: rgba(255,255,255,.03);
}
.thumb{
  width:40px;height:40px;border-radius:14px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  display:grid; place-items:center; font-weight:1000;
}
.meta{flex:1; display:flex; flex-direction:column; gap:4px}
.meta .top{display:flex; justify-content:space-between; gap:12px; align-items:flex-start}
.meta .name{font-weight:1000}
.meta .sub{font-size:12px;color:var(--muted)}
.actions{display:flex; flex-direction:column; gap:8px}
.hidden{display:none !important}

/* Ensure our screens align with index layout */
.container{padding:16px 16px 24px;max-width:520px;margin:0 auto;width:100%}

/* --- Policy chip style (screenshot match) --- */
#policy .chip{
  padding: 14px 18px;
  border-radius: 999px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  font-size: 18px;
  font-weight: 900;
}
#policy .chip .dot{display:none !important}


/* Policy screen sizing adjustments */
#policy div[style*="font-size:44px"]{font-size:34px !important}
#policy div[style*="font-size:30px"]{font-size:22px !important}
#policy .chip{font-size:14px !important; padding:10px 14px !important}
#policy .small{font-size:12px}
#policy .accent{color:#22d3ee; font-weight:1000}

</style>
</head>
<body>
<div id="app">
  <header>
    <div class="brand">
      <div class="mark"></div>
      <span>ATTEST</span>
      <span class="small" style="margin-left:10px">A real-time authorization and intent network for payments</span>
    </div>
  </header>

  <div class="container">
    
<section id="home" class="screen active">
  <div class="card">
    <div class="row">
      <div>
        <div class="h1">Hi, <span id="userName">Jamie</span> ðŸ‘‹</div>
        <div class="small">Work Card â€¢ **** <span id="cardLast4">1842</span></div>
        <div class="small">Spend rules: <span id="policyName"> Field Ops - Standard</span></div>
      </div>
      <div class="pill"><span class="dot"></span>Status: <span id="pillStatusText">Ready</span></div>
    </div>
    <hr/>
    <div class="grid2">
      <div class="kv">
        <b>Todayâ€™s spend</b><span>$<span id="todaySpend">82.40</span></span>
      </div>
      <div class="kv">
        <b>Daily limit</b><span>$<span id="dailyLimit">250.00</span></span>
      </div>
      <div class="kv">
        <b>Auto-approve</b><span>Hardware, fuel, safety, parking</span>
      </div>
      <div class="kv">
        <b>May need approval</b><span>Electronics, large purchases</span>
      </div>
    </div>
    <hr/>
    <button class="btn" id="btnStart">New Purchase</button>
    <div class="grid2" style="margin-top:10px">
      <button class="btn ghost" id="btnPolicy">View Policy</button>
      <button class="btn secondary" id="btnRefresh">Refresh</button>
    </div>
  </div>

  <div style="height:14px"></div>

  <div class="card">
    <div class="row">
      <div class="h2">Recent transactions</div>
      <div class="small" id="txCount">â€”</div>
    </div>
    <div style="height:10px"></div>
    <div id="recentList" class="list"></div>
  </div>

  <div class="small" style="margin-top:10px">Demo tip: Tap <b>New Purchase</b>, then take a photo to auto-fill details.</div>
</section>

    
<section class="screen" id="policy">
  <div class="card" style="padding:18px 16px 16px">
    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px">
      <div>
        <div style="font-size:44px; font-weight:1000; letter-spacing:-0.02em; line-height:1">Policy</div>
        <div style="margin-top:6px; font-size:16px; color:var(--muted)">
          <span id="policyTitle">Field Ops â€” Standard</span> <span style="opacity:.9">(Auto-approve rules)</span>
        </div>
      </div>
      <button class="btn ghost" id="btnBackFromPolicy" style="width:auto; padding:12px 18px; border-radius:18px; font-weight:1000">Back</button>
    </div>
    <div style="height:14px"></div>
    <div style="height:1px; background: rgba(255,255,255,.08);"></div>

    <div style="height:18px"></div>
    <div style="font-size:30px; font-weight:1000; letter-spacing:-0.02em">Auto-approved</div>
    <div id="autoCats" style="display:flex; flex-wrap:wrap; gap:12px; margin-top:14px"></div>

    <div style="height:26px"></div>
    <div style="font-size:30px; font-weight:1000; letter-spacing:-0.02em">Requires manager approval</div>
    <div id="needsCats" style="display:flex; flex-wrap:wrap; gap:12px; margin-top:14px"></div>

    <div style="height:26px"></div>
    <div style="font-size:30px; font-weight:1000; letter-spacing:-0.02em">Hard blocks</div>
    <div id="blockedCats" style="display:flex; flex-wrap:wrap; gap:12px; margin-top:14px"></div>

    <div style="height:18px"></div>
    <div style="height:1px; background: rgba(255,255,255,.08);"></div>
    <div style="margin-top:14px; font-size:14px; color:var(--muted); line-height:1.35">
      In production, these rules live in a centralized policy engine (OPA/Rego-style) with audit-ready evidence.
    </div>
  </div>
</section>

    <section class="screen" id="capture">
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
          <div>
            <div class="label">Step 1 â€” Capture</div>
            <div class="value">Take a photo of the item</div>
          </div>
          <div class="stepPill" id="itemPill"><span class="stepNum" id="itemNum">1</span> Item <span id="itemCountText">1</span></div>
        </div>

        <div style="height:10px"></div>
        <label class="label">Photo</label>
        <input class="input" id="fileInput" type="file" accept="image/*" capture="environment"/>
        <div id="previewWrap" style="margin-top:10px; display:none">
          <img id="previewImg" alt="Evidence preview" style="width:100%; border-radius:16px; border:1px solid rgba(255,255,255,.14)"/>
        </div>

        <hr class="sep"/>
        <label class="label" for="merchantInput">Merchant (auto-filled)</label>
        <input class="input" id="merchantInput" readonly />

        <div style="height:10px"></div>
        <label class="label" for="catInput">Category (auto-filled)</label>
        <input class="input" id="catInput" readonly />

        <div style="height:10px"></div>
        <label class="label" for="amountInput">Approximate amount (you enter)</label>
        <input class="input" id="amountInput" inputmode="decimal" placeholder="e.g., 39.99" />

        <hr class="sep"/>
        <div class="grid2">
          <button class="btn secondary" id="btnAddItem">Add item</button>
          <button class="btn" id="btnFinishPay">Finish and Pay</button>
        </div>
      </div>
      <button class="btn secondary" id="btnCancelPurchase">Cancel</button>
      <div class="footerNote">We auto-detect merchant + category in the demo when you attach a photo.</div>
    </section>
    <section class="screen" id="cart">
      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between">
          <div>
            <div class="label">Step 2 â€” Review</div>
            <div class="value">Your items</div>
          </div>
          <div class="badge" id="approvalBadge">Auto-approved</div>
        </div>
        <hr class="sep"/>
        <div class="list" id="cartList"></div>
        <hr class="sep"/>
        <div class="row">
          <div>
            <div class="label">Merchant</div>
            <div class="value" id="cartMerchant">â€”</div>
          </div>
          <div>
            <div class="label">Total</div>
            <div class="value">$<span id="cartTotal">0.00</span></div>
          </div>
        </div>
      </div>

      <div class="grid2">
        <button class="btn secondary" id="btnAddMore">Add another item</button>
        <button class="btn" id="btnProceed">Proceed to pay</button>
      </div>
      <div style="height:10px"></div>
      <button class="btn secondary" id="btnBackHome">Back to home</button>
    </section>
    <section class="screen" id="pay">
      <div class="card">
        <div class="label">Step 3 â€” Tap to pay</div>
        <div class="value">Ready when approved</div>
        <hr class="sep"/>
        <div class="row">
          <div>
            <div class="label">Merchant</div>
            <div class="value" id="payMerchant">â€”</div>
          </div>
          <div>
            <div class="label">Total</div>
            <div class="value">$<span id="payTotal">0.00</span></div>
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="card" style="margin:0; background: rgba(255,255,255,.05)">
          <div class="row" style="align-items:center; justify-content:space-between">
            <div class="chip"><span class="dot" id="permitDot"></span> <span id="permitText">Permit active (10 min)</span></div>
            <div class="pill" id="timerPill">10:00</div>
          </div>
          <div style="margin-top:10px; font-size:12px; color: var(--muted)">
            Demo: we simulate the real-time authorization decision during the tap.
          </div>
        </div>
        <div style="height:12px"></div>
        <button class="btn" id="btnSimTap">Simulate tap</button>
        <div style="height:10px"></div>
        <button class="btn secondary" id="btnFinish">Finish</button>
      </div>
    </section>
    <section class="screen" id="result">
      <div class="card">
        <div class="label">Result</div>
        <div class="value" id="resultTitle">Approved</div>
        <div style="margin-top:8px; color: var(--muted)" id="resultDetail">â€”</div>
        <hr class="sep"/>
        <div class="row">
          <div>
            <div class="label">Authorization</div>
            <div class="value" id="authId">AUTH-â€”</div>
          </div>
          <div>
            <div class="label">Status</div>
            <div class="value" id="statusText">â€”</div>
          </div>
        </div>
      </div>
      <div class="grid2">
        <button class="btn" id="btnNewPurchase">New purchase</button>
        <button class="btn secondary" id="btnBackToHome2">Back to home</button>
      </div>
    
      <div class="card" id="complianceCard" style="display:none; margin-top:12px">
        <div class="label">Compliance captured</div>
        <div class="value">This purchase met policy at time of payment</div>
        <hr class="sep"/>
        <div class="row">
          <div>
            <div class="label">Policy decision</div>
            <div class="value" id="ccDecision">â€”</div>
          </div>
          <div>
            <div class="label">Evidence</div>
            <div class="value">Photo attached</div>
          </div>
        </div>
        <div style="height:8px"></div>
        <div class="label">Items</div>
        <div id="ccItems" style="font-size:12px; color:var(--muted)"></div>
        <div style="height:8px"></div>
        <div class="label">Permit / Hash</div>
        <div class="value" id="ccHash">â€”</div>
      </div>

</section>
  </div>
</div>

<script>

(function(){
  var state = {
    cart: [],
    permitExpiresAt: 0,
    permitActive: false,
    user: { name:"Jamie", last4:"1842" },
    policy: {
      name:"Field Ops - Standard",
      autoApproved:["Hardware","Fuel","Safety supplies","Parking/Tolls"],
      requiresApproval:["Electronics","Tools > $200","New vendors"],
      blocked:["Gift cards","Alcohol","Cash equivalents"],
      dailyLimit:250,
      todaySpend:82.40
    },
    recent: [
      { merchant:"Shell", amount:18.22, status:"Approved", badge:"ok" },
      { merchant:"Home Depot", amount:46.13, status:"Approved", badge:"ok" },
      { merchant:"Tool Town", amount:229.99, status:"Needs approval", badge:"warn" }
    ],
    autoFill: {
      merchants:["Home Depot","Shell","Ace Hardware","7â€‘Eleven","Safety Supply Co.","City Parking","Tool Town","New Vendor Mart"],
      categories:["Hardware","Fuel","Safety supplies","Parking/Tolls","Electronics","Tools","New vendors","Gift cards","Alcohol","Cash equivalents"]
    }
  };

  function $(id){ return document.getElementById(id); }
  function setPill(text){ var p = $("pillStatus"); if(p) p.textContent = text; var pt = $("pillStatusText"); if(pt) pt.textContent = text; }
  function show(screenId){
    document.querySelectorAll(".screen").forEach(function(s){ s.classList.remove("active"); });
    var el = $(screenId); if(el) el.classList.add("active");
    window.scrollTo({top:0, left:0, behavior:"auto"});
  }
  function fmtMoney(n){ return (Math.round(n*100)/100).toFixed(2); }
  
function makeChip(text, kind){
    var span = document.createElement("span");
    span.className = "chip";
    var dot = document.createElement("span");
    dot.className = "dot" + (kind ? (" " + kind) : "");
    span.appendChild(dot);
    // color the > $200 part
    var safe = (text||"").replace(/>\s*\$?200/g, '<span class="accent">&gt; $200</span>');
    var label = document.createElement("span");
    label.innerHTML = " " + safe;
    span.appendChild(label);
    return span;
}
  function renderPolicy(){
    $("policyTitle").textContent = state.policy.name;
    $("autoCats").innerHTML = "";
    state.policy.autoApproved.forEach(function(t){ $("autoCats").appendChild(makeChip(t)); });
    $("needsCats").innerHTML = "";
    state.policy.requiresApproval.forEach(function(t){ $("needsCats").appendChild(makeChip(t, "amber")); });
    $("blockedCats").innerHTML = "";
    state.policy.blocked.forEach(function(t){ $("blockedCats").appendChild(makeChip(t, "red")); });
  }
  function renderRecent(){
    var tc = $("txCount"); if(tc) tc.textContent = state.recent.length + " items";
    var host = $("recentList"); host.innerHTML = "";
    state.recent.slice(0,4).forEach(function(tx){
      var row = document.createElement("div"); row.className = "item";
      var th = document.createElement("div"); th.className = "thumb"; th.textContent = tx.merchant.substring(0,1).toUpperCase();
      var meta = document.createElement("div"); meta.className = "meta";
      var top = document.createElement("div"); top.className = "top";
      var name = document.createElement("div"); name.className = "name"; name.textContent = tx.merchant;
      var amt = document.createElement("div"); amt.className = "name"; amt.textContent = "$" + fmtMoney(tx.amount);
      top.appendChild(name); top.appendChild(amt);
      var sub = document.createElement("div"); sub.className = "sub"; sub.textContent = tx.status;
      meta.appendChild(top); meta.appendChild(sub);
      var chip = document.createElement("div"); chip.className = "chip";
      var dot = document.createElement("span"); dot.className = "dot" + (tx.badge==="warn" ? " amber" : (tx.badge==="red" ? " red" : ""));
      chip.appendChild(dot); chip.appendChild(document.createTextNode(" " + tx.status));
      row.appendChild(th); row.appendChild(meta); row.appendChild(chip);
      host.appendChild(row);
    });
  }
  function normalizeMerchant(s){ return (s||"").trim() || "Unknown Merchant"; }
  function normalizeCategory(s){ return (s||"").trim() || "Uncategorized"; }
  function parseAmount(s){
    var n = parseFloat((s||"").replace(/[^0-9.]/g,""));
    return isFinite(n) ? n : 0;
  }
  
  function canonicalCategory(cat){
    var c = (cat||"").toLowerCase().trim();
    if(c.includes("parking") || c.includes("toll")) return "parking/tolls";
    if(c.includes("fuel") || c.includes("gas")) return "fuel";
    if(c.includes("hardware")) return "hardware";
    if(c.includes("safety")) return "safety supplies";
    if(c.includes("electronics")) return "electronics";
    if(c.includes("tool")) return "tools";
    if(c.includes("new vendor")) return "new vendors";
    if(c.includes("gift")) return "gift cards";
    if(c.includes("alcohol")) return "alcohol";
    if(c.includes("cash")) return "cash equivalents";
    return c;
  }

function itemStatus(item){
    var cat = canonicalCategory(item.category);
    var amt = (item.amount||0);

    // Hard blocks
    if(cat === "gift cards" || cat === "alcohol" || cat === "cash equivalents") return "Blocked";

    // Requires approval
    if(cat === "electronics") return "Needs approval";
    if(cat === "new vendors") return "Needs approval";
    if(cat === "tools"){
      if(amt > 200) return "Needs approval";
      return "Approved";
    }

    // Auto-approved
    var auto = state.policy.autoApproved.map(function(x){ return x.toLowerCase(); });
    if(auto.indexOf(cat) >= 0){
      if(amt > 300) return "Needs approval";
      return "Approved";
    }

    // Default conservative
    return "Needs approval";
  }
  function overallApproval(){
    if(state.cart.length === 0) return { status:"â€”", badge:"warn" };
    if(state.cart.some(function(i){ return itemStatus(i) === "Blocked"; })) return { status:"Blocked", badge:"block" };
    if(state.cart.some(function(i){ return itemStatus(i) === "Needs approval"; })) return { status:"Needs approval", badge:"warn" };
    return { status:"Auto-approved", badge:"ok" };
  }
  function renderCart(){
    var list = $("cartList"); list.innerHTML = "";
    if(state.cart.length === 0){
      var empty = document.createElement("div");
      empty.style.color = "var(--muted)";
      empty.textContent = "No items yet. Add an item first.";
      list.appendChild(empty);
    } else {
      state.cart.forEach(function(item, idx){
        var row = document.createElement("div"); row.className = "item";
        var th = document.createElement("div"); th.className = "thumb"; th.textContent = String(idx+1);
        var meta = document.createElement("div"); meta.className = "meta";
        var top = document.createElement("div"); top.className = "top";
        var name = document.createElement("div"); name.className = "name"; name.textContent = item.name || ("Item " + (idx+1));
        var amt = document.createElement("div"); amt.className = "name"; amt.textContent = "$" + fmtMoney(item.amount);
        top.appendChild(name); top.appendChild(amt);
        var sub = document.createElement("div"); sub.className = "sub";
        sub.textContent = item.merchant + " â€¢ " + item.category + " â€¢ " + itemStatus(item);
        meta.appendChild(top); meta.appendChild(sub);

        var actions = document.createElement("div"); actions.className = "actions";
        var rm = document.createElement("button");
        rm.className = "btn danger smallbtn"; rm.textContent = "Remove";
        rm.addEventListener("click", function(){ state.cart.splice(idx,1); renderCart(); updateItemPill(); });
        actions.appendChild(rm);

        row.appendChild(th); row.appendChild(meta); row.appendChild(actions);
        list.appendChild(row);
      });
    }
    var total = state.cart.reduce(function(s,i){ return s + (i.amount||0); }, 0);
    $("cartTotal").textContent = fmtMoney(total);
    $("cartMerchant").textContent = state.cart[0] ? normalizeMerchant(state.cart[0].merchant) : "â€”";

    var appr = overallApproval();
    var badge = $("approvalBadge");
    badge.textContent = appr.status;
    badge.className = "badge" + (appr.badge==="warn" ? " warn" : (appr.badge==="block" ? " block" : ""));
  }

  function clearCaptureForm(){
    $("amountInput").value = "";
    $("fileInput").value = "";
    $("previewWrap").style.display = "none";
    $("previewImg").src = "";
    // Keep auto-filled values until next photo, so the user sees them
  }

  function autoFillFromPhoto(){
    var m = state.autoFill.merchants[Math.floor(Math.random()*state.autoFill.merchants.length)];
    var c = state.autoFill.categories[Math.floor(Math.random()*state.autoFill.categories.length)];
    $("merchantInput").value = m;
    $("catInput").value = c;
    setPill("Details auto-filled");
    setTimeout(function(){ setPill("Capturing"); }, 900);
  }

  var timerInt = null;
  function startPermit(minutes){
    state.permitActive = true;
    state.permitExpiresAt = Date.now() + minutes*60*1000;
    $("permitDot").className = "dot";
    if(timerInt) clearInterval(timerInt);
    timerInt = setInterval(function(){
      var ms = state.permitExpiresAt - Date.now();
      if(ms <= 0){
        state.permitActive = false;
        clearInterval(timerInt);
        $("timerPill").textContent = "Expired";
        $("permitText").textContent = "Permit expired";
        $("permitDot").className = "dot red";
        setPill("Permit expired");
      } else {
        var s = Math.floor(ms/1000);
        var m = Math.floor(s/60);
        var r = s % 60;
        $("timerPill").textContent = String(m).padStart(2,"0") + ":" + String(r).padStart(2,"0");
      }
    }, 250);
  }

  function proceedToPay(){
    var total = state.cart.reduce(function(s,i){ return s + (i.amount||0); }, 0);
    $("payTotal").textContent = fmtMoney(total);
    $("payMerchant").textContent = state.cart[0] ? normalizeMerchant(state.cart[0].merchant) : "â€”";
    $("permitText").textContent = "Permit active (10 min)";
    $("timerPill").textContent = "10:00";
    setPill("Permit active");
    startPermit(10);
    show("pay");
  }

  function simulateTap(){
    var appr = overallApproval();
    var total = state.cart.reduce(function(s,i){ return s + (i.amount||0); }, 0);
    var auth = "AUTH-" + Math.random().toString(16).slice(2,8).toUpperCase();

    if(!state.permitActive){
      $("resultTitle").textContent = "Declined";
      $("resultDetail").textContent = "Permit expired â€” authorization denied.";
      $("statusText").textContent = "Declined";
    } else if(appr.status === "Blocked"){
      $("resultTitle").textContent = "Declined";
      $("resultDetail").textContent = "Not allowed by your spend rules.";
      $("statusText").textContent = "Declined";
    } else if(appr.status === "Needs approval"){
      $("resultTitle").textContent = "Pending";
      $("resultDetail").textContent = "Approval needed. In production this routes instantly.";
      $("statusText").textContent = "Pending";
    } else {
      $("resultTitle").textContent = "Approved";
      $("resultDetail").textContent = "Approved in real time. Receipt evidence attached.";
      $("statusText").textContent = "Approved";
      state.policy.todaySpend = state.policy.todaySpend + total;
      $("todaySpend").textContent = fmtMoney(state.policy.todaySpend);
      state.recent.unshift({ merchant: normalizeMerchant(state.cart[0].merchant), amount: total, status:"Approved", badge:"ok" });
      renderRecent();
    }
    $("authId").textContent = auth;
    state.permitActive = false;
    if(timerInt) clearInterval(timerInt);
    setPill("Complete");
    
    var card = $("complianceCard");
    if(card){
      if($("statusText").textContent === "Approved"){
        var itemsTxt = state.cart.map(function(i,idx){
          return (idx+1)+". "+(i.name||"Item")+" â€” "+i.category+" â€” $"+fmtMoney(i.amount);
        }).join("<br/>");
        $("ccItems").innerHTML = itemsTxt;
        $("ccDecision").textContent = "Auto-approved by policy";
        $("ccHash").textContent = auth + "-EVID";
        card.style.display = "block";
      } else {
        card.style.display = "none";
      }
    }
    
    show("result");
  }

  function updateItemPill(){
    var next = state.cart.length + 1;
    $("itemNum").textContent = String(next);
    $("itemCountText").textContent = String(next);
  }

  function startPurchase(){
    state.cart = [];
    $("merchantInput").value = "";
    $("catInput").value = "";
    clearCaptureForm();
    updateItemPill();
    setPill("Capturing");
    show("capture");
  }

  function addCurrentItemToCart(){
    var merchant = normalizeMerchant($("merchantInput").value);
    var category = normalizeCategory($("catInput").value);
    var amount = parseAmount($("amountInput").value);
    if(amount <= 0){
      alert("Enter an approximate amount to add this item.");
      return false;
    }
    // enforce one-merchant-per-checkout for realism
    if(state.cart.length > 0){
      var existing = normalizeMerchant(state.cart[0].merchant);
      if(existing.toLowerCase() !== merchant.toLowerCase()){
        alert("This demo keeps one checkout to one merchant. Start a new purchase for a different merchant.");
        return false;
      }
    }
    var idx = state.cart.length + 1;
    state.cart.push({
      merchant: merchant,
      category: category,
      amount: amount,
      name: "Item " + idx
    });
    clearCaptureForm();
    updateItemPill();
    setPill("Item " + idx + " added");
    setTimeout(function(){ setPill("Capturing"); }, 900);
    return true;
  }

  function init(){
    $("userName").textContent = state.user.name;
    $("policyName").textContent = state.policy.name;
    $("cardLast4").textContent = state.user.last4;
    $("todaySpend").textContent = fmtMoney(state.policy.todaySpend);
    $("dailyLimit").textContent = fmtMoney(state.policy.dailyLimit);

    renderRecent();
    renderPolicy();

    var br = $("btnRefresh");
    if(br){
      br.addEventListener("click", function(){
        var bump = (Math.random()*12).toFixed(2);
        state.policy.todaySpend = state.policy.todaySpend + Number(bump);
        $("todaySpend").textContent = fmtMoney(state.policy.todaySpend);
        if(navigator.vibrate) navigator.vibrate(20);
        setPill("Refreshed");
        setTimeout(function(){ setPill("Ready"); }, 700);
      });
    }

    $("btnStart").addEventListener("click", startPurchase);
    $("btnPolicy").addEventListener("click", function(){ show("policy"); setPill("Spend rules"); });
    $("btnBackFromPolicy").addEventListener("click", function(){ show("home"); setPill("Ready"); });

    $("btnCancelPurchase").addEventListener("click", function(){ show("home"); setPill("Ready"); });

    $("btnAddItem").addEventListener("click", function(){
      if(!$("merchantInput").value){
        alert("Take a photo first so we can auto-fill the details.");
        return;
      }
      addCurrentItemToCart();
    });

    $("btnFinishPay").addEventListener("click", function(){
      // If there is an amount entered, treat it as adding the current item before finishing.
      if($("merchantInput").value && $("amountInput").value.trim()){
        var ok = addCurrentItemToCart();
        if(!ok) return;
      }
      if(state.cart.length === 0){
        alert("Add at least one item first.");
        return;
      }
      renderCart();
      show("cart");
      setPill("Reviewing");
    });

    $("btnAddMore").addEventListener("click", function(){ show("capture"); setPill("Capturing"); });

    $("btnProceed").addEventListener("click", function(){
      if(state.cart.length === 0){ alert("Add at least one item first."); return; }
      proceedToPay();
    });

    $("btnBackHome").addEventListener("click", function(){ show("home"); setPill("Ready"); });

    $("btnSimTap").addEventListener("click", simulateTap);
    $("btnFinish").addEventListener("click", function(){ show("home"); setPill("Ready"); });

    $("btnNewPurchase").addEventListener("click", startPurchase);
    $("btnBackToHome2").addEventListener("click", function(){ show("home"); setPill("Ready"); });

    $("fileInput").addEventListener("change", function(){
      var f = this.files && this.files[0] ? this.files[0] : null;
      if(!f){ $("previewWrap").style.display = "none"; return; }
      var url = URL.createObjectURL(f);
      $("previewImg").src = url;
      $("previewWrap").style.display = "block";
      // demo auto-fill
      autoFillFromPhoto();
    });

    show("home");
    setPill("Ready");
  }

  document.addEventListener("DOMContentLoaded", init);
})();

</script>
</body>
</html>
